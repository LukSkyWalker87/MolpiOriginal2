<!-- ====== GRILLA: look & feel Productos ====== -->
<style>
.promociones-component .card { box-shadow: 0 2px 4px rgba(0,0,0,.08); border: 0; }
.promociones-component .card-header { background:#fff; border-bottom:1px solid #e9ecef; padding:.75rem 1rem; }
.promociones-component .toolbar .form-control { height:36px; font-size:.875rem; }
.promociones-component .btn { border-radius:.375rem; }
.promociones-component .btn-sm { padding:.3rem .55rem; font-size:.8rem; }
.promociones-component .table { margin:0; font-size:.85rem; }
.promociones-component .table thead th{
  background:#f8f9fa; border-bottom:2px solid #dee2e6; color:#495057;
  font-weight:600; font-size:.75rem; padding:.45rem .6rem; white-space:nowrap;
}
.promociones-component .table td{
  padding:.45rem .6rem; vertical-align:middle; border-top:1px solid #eef1f4; white-space:nowrap;
}
.promociones-component .table tbody tr:hover { background:#f7f9fb; }
.promociones-component .thumb {
  width:76px; height:46px; object-fit:cover; border-radius:6px; border:1px solid #e9ecef;
}
.promociones-component .badge { font-weight:600; font-size:.67rem; padding:.35em .5em; }
.promociones-component .badge-soft { background:#eef2f7; color:#5b6b7a; border:1px solid #e2e7ee; }
.promociones-component .badge-img { background:#e6f4ea; color:#207245; border:1px solid #cfead7; }
.promociones-component .badge-pdf { background:#e8f1fb; color:#1f5faa; border:1px solid #d6e6fa; }
.promociones-component .estado-activo { background:#28a745; }
.promociones-component .estado-inactivo { background:#dc3545; }
.promociones-component .acciones .btn { min-width:82px; }
.promociones-component .acciones .btn i{ margin-right:.25rem; }

/* Modal moderno */
.promociones-component .modal-content{ border:none; border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,.12); }
.promociones-component .modal-header{
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; border:0; border-radius:12px 12px 0 0;
}
.promociones-component .modal-title{ font-weight:600; font-size:1.1rem; }
.promociones-component .modal-body{ background:#fafafa; }
.promociones-component .form-group label{ font-weight:600; color:#4a5568; font-size:.9rem; }
.promociones-component .form-control{ border:2px solid #e2e8f0; border-radius:8px; }
.promociones-component .form-control:focus{ border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,.12); }
.promociones-component .preview-img{ max-height:200px; border:2px solid #e2e8f0; border-radius:8px; }

/* Toasts */
.toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
.custom-toast { min-width: 300px; margin-bottom: 10px; border-left: 4px solid; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.custom-toast.success { border-left-color: #28a745; background-color: #d4edda; }
.custom-toast.error { border-left-color: #dc3545; background-color: #f8d7da; }
.custom-toast.info { border-left-color: #17a2b8; background-color: #d1ecf1; }
.custom-toast .toast-header { background:transparent; border-bottom: 1px solid rgba(0,0,0,0.1); }
.custom-toast .toast-body { color: #495057; line-height: 1.4; }
.custom-toast .close { color: inherit; opacity: .8; }
.custom-toast .close:hover { opacity: 1; }
</style>

<!-- OVERRIDES – hacer la grilla menos chica -->
<style>
/* más aire en el card */
.promociones-component .card-body{ padding:1rem !important; }

/* buscar + botones un poco más grandes */
.promociones-component .toolbar .form-control{ height:42px; font-size:.95rem; }
.promociones-component .btn-sm{ padding:.45rem .75rem; font-size:.9rem; }

/* tipografías y paddings de tabla más grandes */
.promociones-component .table{ font-size:.95rem; }
.promociones-component .table thead th{
  font-size:.85rem;
  padding:.65rem .85rem;
}
.promociones-component .table td{
  padding:.65rem .85rem;
}

/* miniaturas más grandes */
.promociones-component .thumb{
  width:110px;   /* antes 76 */
  height:66px;   /* antes 46 */
  border-radius:8px;
}

/* badges más legibles */
.promociones-component .badge{
  font-size:.75rem;
  padding:.4em .6em;
}

/* botones de acciones con ancho y altura cómodos */
.promociones-component .acciones .btn{
  min-width:96px;
  padding:.45rem .7rem;
  font-size:.9rem;
}

/* fila hover apenas más notorio */
.promociones-component .table tbody tr:hover{ background:#f3f6fb; }

/* en pantallas grandes, subimos un poquito más */
@media (min-width:1200px){
  .promociones-component .table{ font-size:1rem; }
  .promociones-component .table thead th{ font-size:.9rem; }
  .promociones-component .thumb{ width:120px; height:72px; }
}
</style>

<div class="promociones-component">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6 class="mb-0"><i class="fa fa-bullhorn mr-2"></i>Gestión de Promociones</h6>
      <div class="toolbar d-flex align-items-center">
        <input id="buscarPromocion" class="form-control mr-2" placeholder="Buscar promociones...">
        <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#promocionModal" onclick="limpiarFormulario()">
          <i class="fa fa-plus"></i> Nuevo
        </button>
      </div>
    </div>

    <div class="card-body p-2">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Imagen</th>
              <th>Título</th>
              <th>Archivos</th>
              <th>Estado</th>
              <th>Fecha</th>
              <th class="text-right">Acciones</th>
            </tr>
          </thead>
          <tbody id="promocionesTableBody">
            <!-- filas dinámicas -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal Agregar/Editar -->
<div class="modal fade" id="promocionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form class="modal-content" id="promocionForm">
      <div class="modal-header">
        <h5 class="modal-title" id="promocionModalLabel"><i class="fa fa-bullhorn mr-2"></i>Agregar Nueva Promoción</h5>
        <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="promocionId">

        <div class="form-group">
          <label for="promocionTitulo">Título</label>
          <input type="text" id="promocionTitulo" class="form-control" placeholder="Ej: Promo Agosto -25% OFF" required>
        </div>

        <div class="form-row">
          <div class="form-group col-md-6">
            <label>Imagen (opcional)</label>
            <input type="file" class="form-control-file mb-2" id="promocionImagenFile" accept="image/*">
            <small class="text-muted">Recomendado 1200×400px (opcional)</small>
            <div id="archivoEstadoImagen" class="mt-2 d-none"><span class="badge badge-img">IMG seleccionada</span></div>
            <div id="imagenPreview" class="mt-3 d-none">
              <img id="imagenPreviewImg" class="preview-img" alt="Vista previa">
            </div>
          </div>

          <div class="form-group col-md-6">
            <label>Cartilla PDF (opcional)</label>
            <input type="file" class="form-control-file mb-2" id="promocionPdfFile" accept=".pdf">
            <div id="archivoEstadoPdf" class="mt-2 d-none"><span class="badge badge-pdf">PDF seleccionado</span></div>
            <div id="pdfPreview" class="mt-3 d-none">
              <div class="alert alert-info py-2 px-3 mb-0">
                <i class="fa fa-file-pdf-o"></i> <span id="pdfFileName"></span>
                <a id="pdfPreviewLink" href="#" target="_blank" class="btn btn-sm btn-outline-info ml-2"><i class="fa fa-eye"></i> Ver</a>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group mb-0">
          <div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" id="promocionActivo" checked>
            <label class="custom-control-label" for="promocionActivo">Promoción activa (visible en el sitio)</label>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-dismiss="modal"><i class="fa fa-times mr-1"></i>Cancelar</button>
        <button class="btn btn-primary" id="guardarPromocionBtn" type="submit"><i class="fa fa-save mr-1"></i>Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Confirmación Eliminar -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteConfirmModalLabel"><i class="fa fa-exclamation-triangle mr-2"></i>Confirmar eliminación</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body">
        <div class="text-center">
          <div class="mb-3"><i class="fa fa-trash-o" style="font-size:48px;color:#dc3545;"></i></div>
          <h5 class="mb-3">¿Estás seguro de eliminar esta promoción?</h5>
          <p class="text-muted mb-0">Esta acción no se puede deshacer.</p>
        </div>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-dismiss="modal"><i class="fa fa-times mr-1"></i>Cancelar</button>
        <button type="button" class="btn btn-danger ml-2" id="confirmDeleteBtn"><i class="fa fa-trash-o mr-1"></i>Sí, eliminar</button>
      </div>
    </div>
  </div>
</div>

<!-- Toasts -->
<div id="toastContainer" class="toast-container"></div>

<script>
// ===== TOASTS =====
function showToast(message, type = 'success', duration = 4000) {
  const toastContainer = document.getElementById('toastContainer');
  const toastId = 'toast-' + Date.now();
  const toastHTML = `
    <div class="toast custom-toast ${type}" id="${toastId}" role="alert">
      <div class="toast-header">
        <strong class="mr-auto">${type === 'success' ? '✅ Éxito' : type === 'error' ? '❌ Error' : '💡 Info'}</strong>
        <button type="button" class="close" data-dismiss="toast"><span>&times;</span></button>
      </div>
      <div class="toast-body">${message}</div>
    </div>`;
  toastContainer.insertAdjacentHTML('beforeend', toastHTML);
  const toastElement = document.getElementById(toastId);
  $(toastElement).toast({ autohide: true, delay: duration });
  $(toastElement).toast('show');
  $(toastElement).on('hidden.bs.toast', function(){ toastElement.remove(); });
}

// ===== RENDER ROW (look Productos) =====
function renderPromocionRow(promocion){
  const estado = promocion.activo
    ? '<span class="badge estado-activo">Activo</span>'
    : '<span class="badge estado-inactivo">Inactivo</span>';

  const archivos = `
    <span class="badge ${promocion.imagen ? 'badge-img' : 'badge-soft'} mr-1"><i class="fa fa-image"></i> IMG</span>
    <span class="badge ${promocion.cartilla_pdf ? 'badge-pdf' : 'badge-soft'}"><i class="fa fa-file-pdf-o"></i> PDF</span>
  `;

  const fecha = promocion.fecha_creacion
    ? new Date(promocion.fecha_creacion).toLocaleDateString('es-AR')
    : '-';

  return `
    <tr>
      <td>
        <img class="thumb" src="${promocion.imagen || ''}" alt=""
             onerror="this.src=''; this.outerHTML='<span class=&quot;text-muted&quot;>Sin imagen</span>';">
      </td>
      <td>${promocion.titulo || '<em>Sin título</em>'}</td>
      <td>${archivos}</td>
      <td>${estado}</td>
      <td>${fecha}</td>
      <td class="text-right acciones">
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-primary" onclick="editarPromocion(${promocion.id})"><i class="fa fa-edit"></i> Editar</button>
          <button class="btn btn-sm btn-outline-danger"  onclick="eliminarPromocion(${promocion.id})"><i class="fa fa-trash"></i> Eliminar</button>
        </div>
      </td>
    </tr>`;
}

// ===== CARGAR =====
async function cargarPromociones() {
  try {
    const tbody = document.getElementById('promocionesTableBody');
    if (!tbody) return;
    
    const token = localStorage.getItem('token');
    const response = await fetch('/promociones/admin', {
      headers: token ? { 'Authorization': `Bearer ${token}` } : {}
    });
    
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const promociones = await response.json();
    
    tbody.innerHTML = (promociones && promociones.length)
      ? promociones.map(renderPromocionRow).join('')
      : '<tr><td colspan="6" class="text-center text-muted">No hay promociones registradas</td></tr>';
  } catch (error) {
    console.error('Error cargando promociones:', error);
    const tbody = document.getElementById('promocionesTableBody');
    if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error: ' + error.message + '</td></tr>';
  }
}

// ===== GUARDAR =====
async function guardarPromocion(event) {
  if (event) event.preventDefault();
  const btn = document.getElementById('guardarPromocionBtn');
  const originalText = btn.innerHTML;
  try {
    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Guardando...';
    btn.disabled = true;

    let imagenUrl = '';
    let pdfUrl = '';

    // Helper para obtener el token
    const getToken = () => localStorage.getItem('token');

    // subir imagen si hay archivo
    const imgFile = document.getElementById('promocionImagenFile');
    if (imgFile && imgFile.files.length) {
      const fd = new FormData(); 
      fd.append('file', imgFile.files[0]);
      const up = await fetch('/upload/promocion', { 
        method: 'POST', 
        headers: { 'Authorization': `Bearer ${getToken()}` },
        body: fd 
      });
      const res = await up.json();
      if (!up.ok) throw new Error('Error subiendo imagen: ' + (res.error || ''));
      imagenUrl = res.path;
    }

    // subir pdf si hay archivo
    const pdfFile = document.getElementById('promocionPdfFile');
    if (pdfFile && pdfFile.files.length) {
      const fd = new FormData(); 
      fd.append('file', pdfFile.files[0]);
      const up = await fetch('/upload/promocion', { 
        method: 'POST', 
        headers: { 'Authorization': `Bearer ${getToken()}` },
        body: fd 
      });
      const res = await up.json();
      if (!up.ok) throw new Error('Error subiendo PDF: ' + (res.error || ''));
      pdfUrl = res.path;
    }

    // Preparar datos de la promoción
    const promocionId = document.getElementById('promocionId').value;
    const data = {
      titulo: document.getElementById('promocionTitulo').value,
      imagen: imagenUrl || null,
      cartilla_pdf: pdfUrl || null,
      activo: document.getElementById('promocionActivo').checked ? 1 : 0
    };

    const url = promocionId ? `/promociones/${promocionId}` : '/promociones';
    const method = promocionId ? 'PUT' : 'POST';

    const response = await fetch(url, {
      method,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${getToken()}`
      },
      body: JSON.stringify(data)
    });

    if (!response.ok) {
      const result = await response.json();
      throw new Error(result.error || 'Error al guardar');
    }

    showToast(promocionId ? 'Promoción actualizada correctamente' : 'Promoción creada correctamente', 'success');
    $('#promocionModal').modal('hide');
    setTimeout(cargarPromociones, 300);

  } catch (e) {
    console.error(e); 
    showToast('Error: ' + e.message, 'error');
  } finally {
    btn.innerHTML = originalText; 
    btn.disabled = false;
  }
}

// ===== EDITAR =====
async function editarPromocion(id) {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/promociones/admin', {
      headers: token ? { 'Authorization': `Bearer ${token}` } : {}
    });
    
    const promociones = await response.json();
    const p = promociones.find(x => x.id === id);
    if (!p) { showToast('Promoción no encontrada', 'error'); return; }

    document.getElementById('promocionId').value = p.id;
    document.getElementById('promocionTitulo').value = p.titulo || '';
    document.getElementById('promocionActivo').checked = !!p.activo;
    document.getElementById('promocionModalLabel').textContent = 'Editar Promoción';

    // preview imagen
    const prev = document.getElementById('imagenPreview');
    const img  = document.getElementById('imagenPreviewImg');
    if (p.imagen){ img.src = p.imagen; prev.classList.remove('d-none'); }

    // preview pdf
    if (p.cartilla_pdf){
      const pdfPrev = document.getElementById('pdfPreview');
      const pdfLink = document.getElementById('pdfPreviewLink');
      const pdfName = document.getElementById('pdfFileName');
      pdfName.textContent = p.cartilla_pdf.split('/').pop();
      pdfLink.href = p.cartilla_pdf;
      pdfPrev.classList.remove('d-none');
    }

    $('#promocionModal').modal('show');
  } catch (e) {
    console.error(e); showToast('Error al cargar la promoción', 'error');
  }
}

// ===== ELIMINAR =====
function eliminarPromocion(id) {
  $('#deleteConfirmModal').modal('show');
  $('#confirmDeleteBtn').off('click').on('click', async function(){
    $('#deleteConfirmModal').modal('hide');
    try{
      const token = localStorage.getItem('token');
      const r = await fetch(`/promociones/${id}`, {
        method: 'DELETE',
        headers: token ? { 'Authorization': `Bearer ${token}` } : {}
      });
      const j = await r.json();
      if (!r.ok) throw new Error(j.error||'Error al eliminar');
      showToast('Promoción eliminada correctamente', 'success');
      cargarPromociones();
    }catch(e){
      console.error(e); showToast('Error al eliminar la promoción', 'error');
    }
  });
}

// ===== LIMPIAR FORM =====
function limpiarFormulario() {
  document.getElementById('promocionForm').reset();
  document.getElementById('promocionId').value = '';
  document.getElementById('promocionModalLabel').textContent = 'Agregar Nueva Promoción';
  document.getElementById('imagenPreview').classList.add('d-none');
  document.getElementById('pdfPreview').classList.add('d-none');
  document.getElementById('archivoEstadoImagen').classList.add('d-none');
  document.getElementById('archivoEstadoPdf').classList.add('d-none');
}

// ===== INIT =====
function inicializarPromociones() {
  // listeners form
  const form = document.getElementById('promocionForm');
  form?.addEventListener('submit', guardarPromocion);

  // file imagen
  const fileInput = document.getElementById('promocionImagenFile');
  fileInput?.addEventListener('change', function() {
    const file = this.files[0]; if (!file) return;
    if (!file.type.startsWith('image/')) { showToast('Seleccione una imagen válida', 'error'); this.value=''; return; }
    if (file.size > 5*1024*1024)       { showToast('Imagen muy grande (máx. 5MB)', 'error'); this.value=''; return; }
    document.getElementById('archivoEstadoImagen').classList.remove('d-none');
    const reader = new FileReader();
    reader.onload = e => {
      const prev = document.getElementById('imagenPreview');
      const img  = document.getElementById('imagenPreviewImg');
      img.src = e.target.result; prev.classList.remove('d-none');
    };
    reader.readAsDataURL(file);
  });

  // file pdf
  const pdfFileInput = document.getElementById('promocionPdfFile');
  pdfFileInput?.addEventListener('change', function() {
    const file = this.files[0]; if (!file) return;
    if (file.type !== 'application/pdf'){ showToast('Seleccione un PDF válido', 'error'); this.value=''; return; }
    if (file.size > 10*1024*1024)       { showToast('PDF muy grande (máx. 10MB)', 'error'); this.value=''; return; }
    document.getElementById('archivoEstadoPdf').classList.remove('d-none');
    const pdfPrev = document.getElementById('pdfPreview');
    const pdfName = document.getElementById('pdfFileName');
    const pdfLink = document.getElementById('pdfPreviewLink');
    pdfName.textContent = file.name;
    pdfLink.href = URL.createObjectURL(file);
    pdfPrev.classList.remove('d-none');
  });

  // limpiar al cerrar modal
  $('#promocionModal').on('hidden.bs.modal', limpiarFormulario);

  // búsqueda rápida por título
  document.getElementById('buscarPromocion')?.addEventListener('input', function(){
    const q = this.value.trim().toLowerCase();
    [...document.querySelectorAll('#promocionesTableBody tr')].forEach(tr=>{
      const titulo = tr.children[1]?.innerText.toLowerCase() || '';
      tr.style.display = titulo.includes(q) ? '' : 'none';
    });
  });

  // cargar
  cargarPromociones();
}

document.addEventListener('DOMContentLoaded', () => setTimeout(inicializarPromociones, 100));
</script>
