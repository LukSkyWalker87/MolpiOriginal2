<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">üì¢ Gesti√≥n de Promociones</h1>
    
    <!-- Bot√≥n para agregar nueva promoci√≥n -->
    <div class="mb-4">
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#promocionModal">
            <i class="fa fa-plus"></i> Agregar Nueva Promoci√≥n
        </button>
        <button type="button" class="btn btn-success ml-2" onclick="cargarPromociones()">
            <i class="fa fa-refresh"></i> Recargar Promociones
        </button>
    </div>
    
    <!-- Tabla de promociones -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Lista de Promociones</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="promocionesTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>T√≠tulo</th>
                            <th>Estado</th>
                            <th>Fecha Creaci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="promocionesTableBody">
                        <!-- Las promociones se cargan din√°micamente aqu√≠ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para agregar/editar promoci√≥n -->
<div class="modal fade" id="promocionModal" tabindex="-1" role="dialog" aria-labelledby="promocionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="promocionModalLabel">Agregar Nueva Promoci√≥n</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="promocionForm">
                <div class="modal-body">
                    <input type="hidden" id="promocionId" name="promocionId">
                    
                    <!-- T√≠tulo -->
                    <div class="form-group">
                        <label for="promocionTitulo">T√≠tulo (opcional)</label>
                        <input type="text" class="form-control" id="promocionTitulo" name="titulo" 
                               placeholder="Ej: Oferta Especial - 20% de descuento">
                        <small class="form-text text-muted">Si no se especifica t√≠tulo, solo se mostrar√° la imagen</small>
                    </div>
                    
                    <!-- Imagen -->
                    <div class="form-group">
                        <label for="promocionImagen">Imagen de la Promoci√≥n *</label>
                        <input type="file" class="form-control-file" id="promocionImagenFile" accept="image/*">
                        <input type="text" class="form-control mt-2" id="promocionImagen" name="imagen" 
                               placeholder="O ingrese la URL de la imagen">
                        <small class="form-text text-muted">Suba una imagen o ingrese la URL. Recomendado: 1200x400px</small>
                        
                        <!-- Estado del archivo -->
                        <div id="archivoEstado" class="mt-2" style="display: none;">
                            <span class="badge badge-success">
                                <i class="fa fa-check"></i> Archivo seleccionado
                            </span>
                        </div>
                        
                        <!-- Vista previa de la imagen -->
                        <div id="imagenPreview" class="mt-3" style="display: none;">
                            <img id="imagenPreviewImg" src="" alt="Vista previa" class="img-fluid" style="max-height: 200px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <!-- Estado -->
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="promocionActivo" name="activo" checked>
                            <label class="form-check-label" for="promocionActivo">
                                Promoci√≥n activa (visible en el sitio web)
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="guardarPromocionBtn">
                        <i class="fa fa-save"></i> Guardar Promoci√≥n
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Hacer la funci√≥n global para poder llamarla desde el bot√≥n
window.cargarPromociones = cargarPromociones;

// Funci√≥n para cargar promociones en la tabla
async function cargarPromociones() {
    console.log('üîÑ [cargarPromociones] Iniciando carga de promociones...');
    
    try {
        // Verificar que el elemento de la tabla exista
        const tbody = document.getElementById('promocionesTableBody');
        if (!tbody) {
            console.error('‚ùå [cargarPromociones] No se encontr√≥ el elemento promocionesTableBody');
            return;
        }
        
        console.log('üì° [cargarPromociones] Haciendo fetch a http://localhost:5000/promociones/admin...');
        const response = await fetch('http://localhost:5000/promociones/admin');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const promociones = await response.json();
        console.log('üì¶ [cargarPromociones] Promociones recibidas:', promociones);
        
        // Asegurar que promociones sea un array
        let listaPromociones = Array.isArray(promociones) ? promociones : [promociones];
        
        tbody.innerHTML = '';
        
        if (!listaPromociones || listaPromociones.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay promociones registradas</td></tr>';
            console.log('‚ÑπÔ∏è [cargarPromociones] No hay promociones para mostrar');
            return;
        }
        
        listaPromociones.forEach((promocion, index) => {
            console.log(`üìù [cargarPromociones] Procesando promoci√≥n ${index + 1}:`, promocion);
            
            const row = document.createElement('tr');
            
            // Determinar el estado
            const estadoBadge = promocion.activo ? 
                '<span class="badge badge-success">Activa</span>' : 
                '<span class="badge badge-secondary">Inactiva</span>';
            
            // Formatear fecha
            const fecha = new Date(promocion.fecha_creacion).toLocaleDateString('es-AR');
            
            // Crear la URL completa de la imagen para debuggear
            const imagenUrl = promocion.imagen;
            console.log(`üñºÔ∏è [cargarPromociones] URL de imagen para promoci√≥n ${promocion.id}:`, imagenUrl);
            
            row.innerHTML = `
                <td>
                    <div style="position: relative;">
                        <img src="${imagenUrl}" 
                             alt="Promoci√≥n ${promocion.titulo || promocion.id}" 
                             style="max-width: 100px; max-height: 60px; object-fit: cover; border-radius: 4px;" 
                             onload="console.log('‚úÖ Imagen cargada:', this.src)"
                             onerror="console.error('‚ùå Error cargando imagen:', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="display: none; width: 100px; height: 60px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; align-items: center; justify-content: center; color: #6c757d; font-size: 10px; text-align: center;">
                            <div>
                                <i class="fa fa-image" style="font-size: 16px; margin-bottom: 2px;"></i><br>
                                Sin imagen
                            </div>
                        </div>
                    </div>
                </td>
                <td>${promocion.titulo || '<em>Sin t√≠tulo</em>'}</td>
                <td>${estadoBadge}</td>
                <td>${fecha}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="editarPromocion(${promocion.id})" title="Editar">
                            <i class="fa fa-edit"></i> Editar
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarPromocion(${promocion.id})" title="Eliminar">
                            <i class="fa fa-trash"></i> Eliminar
                        </button>
                    </div>
                </td>
            `;
            
            tbody.appendChild(row);
        });
        
        console.log(`‚úÖ [cargarPromociones] ${listaPromociones.length} promociones cargadas exitosamente`);
        
    } catch (error) {
        console.error('üí• [cargarPromociones] Error:', error);
        const tbody = document.getElementById('promocionesTableBody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error al cargar promociones: ' + error.message + '</td></tr>';
        }
        alert('Error al cargar las promociones: ' + error.message);
    }
}

// Funci√≥n para limpiar el formulario
function limpiarFormularioPromocion() {
    document.getElementById('promocionForm').reset();
    document.getElementById('promocionId').value = '';
    document.getElementById('promocionModalLabel').textContent = 'Agregar Nueva Promoci√≥n';
    document.getElementById('imagenPreview').style.display = 'none';
    document.getElementById('archivoEstado').style.display = 'none';
    
    // Limpiar el input de archivo y sus datos
    const fileInput = document.getElementById('promocionImagenFile');
    fileInput.value = '';
    delete fileInput.dataset.fileName;
    delete fileInput.dataset.fileData;
    
    // Restaurar placeholder
    document.getElementById('promocionImagen').placeholder = 'O ingrese la URL de la imagen';
}

// Funci√≥n para mostrar vista previa de imagen
function mostrarVistaPrevia(src) {
    const preview = document.getElementById('imagenPreview');
    const img = document.getElementById('imagenPreviewImg');
    
    if (src) {
        img.src = src;
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
}

// Funci√≥n para inicializar event listeners (para carga din√°mica)
function inicializarPromocionesEventListeners() {
    console.log('üîß [inicializarEventListeners] Iniciando...');
    
    // Evitar m√∫ltiples inicializaciones
    if (window.promocionesEventListenersInicializados) {
        console.log('‚è≠Ô∏è [inicializarEventListeners] Ya inicializados, saltando...');
        return;
    }
    
    const promocionForm = document.getElementById('promocionForm');
    const promocionImagenInput = document.getElementById('promocionImagen');
    const promocionFileInput = document.getElementById('promocionImagenFile');
    const guardarBtn = document.getElementById('guardarPromocionBtn');
    
    console.log('üîç [inicializarEventListeners] Elementos encontrados:', {
        form: !!promocionForm,
        imageInput: !!promocionImagenInput,
        fileInput: !!promocionFileInput,
        saveBtn: !!guardarBtn
    });
    
    // Asegurar que guardarPromocion est√© disponible globalmente
    if (typeof window.guardarPromocion === 'undefined') {
        window.guardarPromocion = guardarPromocion;
        console.log('‚úÖ [inicializarEventListeners] Funci√≥n guardarPromocion expuesta globalmente');
    }
    
    // Event listener del formulario
    if (promocionForm) {
        promocionForm.addEventListener('submit', function(e) {
            console.log('üìù [inicializarEventListeners] Formulario enviado');
            e.preventDefault();
            guardarPromocion(e);
        });
        console.log('‚úÖ [inicializarEventListeners] Event listener del formulario registrado');
    }
    
    // Event listener para imagen URL
    if (promocionImagenInput) {
        promocionImagenInput.addEventListener('input', function() {
            mostrarVistaPrevia(this.value);
        });
        console.log('‚úÖ [inicializarEventListeners] Event listener de imagen URL registrado');
    }
    
    // Event listener para archivo
    if (promocionFileInput) {
        promocionFileInput.addEventListener('change', function() {
            console.log('üìÅ [inicializarEventListeners] Archivo seleccionado:', this.files[0]?.name);
            handleFileSelection(this);
        });
        console.log('‚úÖ [inicializarEventListeners] Event listener de archivo registrado');
    }
    
    // Setup modal events
    $(document).off('hidden.bs.modal', '#promocionModal').on('hidden.bs.modal', '#promocionModal', function () {
        limpiarFormularioPromocion();
    });
    
    // Marcar como inicializado
    window.promocionesEventListenersInicializados = true;
    console.log('‚úÖ [inicializarEventListeners] Completado');
}

// Funci√≥n separada para manejar selecci√≥n de archivo
function handleFileSelection(fileInput) {
    const file = fileInput.files[0];
    if (!file) {
        // Limpiar si no hay archivo
        const imageUrlInput = document.getElementById('promocionImagen');
        if (imageUrlInput) {
            imageUrlInput.value = '';
            imageUrlInput.placeholder = 'O ingrese la URL de la imagen';
        }
        document.getElementById('imagenPreview').style.display = 'none';
        document.getElementById('archivoEstado').style.display = 'none';
        return;
    }
    
    // Validar tipo de archivo
    if (!file.type.startsWith('image/')) {
        alert('Por favor seleccione un archivo de imagen v√°lido');
        fileInput.value = '';
        return;
    }
    
    // Validar tama√±o (m√°ximo 5MB)
    if (file.size > 5 * 1024 * 1024) {
        alert('El archivo es demasiado grande. Tama√±o m√°ximo: 5MB');
        fileInput.value = '';
        return;
    }
    
    console.log('üìÅ [handleFileSelection] Procesando archivo v√°lido:', file.name);
    
    // Generar nombre √∫nico
    const timestamp = Date.now();
    const fileName = `promo_${timestamp}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
    const imagePath = `img/promociones/${fileName}`;
    
    // Actualizar campo URL
    const imageUrlInput = document.getElementById('promocionImagen');
    if (imageUrlInput) {
        imageUrlInput.value = imagePath;
        imageUrlInput.placeholder = 'Archivo seleccionado: ' + file.name;
        console.log('‚úÖ [handleFileSelection] Campo URL actualizado:', imagePath);
    }
    
    // Mostrar indicadores
    document.getElementById('archivoEstado').style.display = 'block';
    
    // Vista previa
    const reader = new FileReader();
    reader.onload = function(e) {
        mostrarVistaPrevia(e.target.result);
        fileInput.dataset.fileName = fileName;
        fileInput.dataset.fileData = e.target.result;
    };
    reader.readAsDataURL(file);
}
async function guardarPromocion(event) {
    console.log('üíæ guardarPromocion ejecutada - inicio');
    
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    const btn = document.getElementById('guardarPromocionBtn');
    const originalText = btn ? btn.innerHTML : '';
    
    console.log('üîç Estado inicial:', {
        btnExists: !!btn,
        originalText: originalText
    });
    
    if (btn) {
        btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Guardando...';
        btn.disabled = true;
    }
    
    try {
        let imagenUrl = document.getElementById('promocionImagen').value;
        console.log('üì∑ URL de imagen inicial:', imagenUrl);
        
        // Si hay un archivo seleccionado, subirlo primero
        const fileInput = document.getElementById('promocionImagenFile');
        if (fileInput && fileInput.files.length > 0) {
            console.log('üìÅ Subiendo archivo:', fileInput.files[0].name);
            
            if (btn) btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Subiendo imagen...';
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            console.log('üöÄ Enviando archivo al servidor...');
            const uploadResponse = await fetch('http://localhost:5000/upload/promocion', {
                method: 'POST',
                body: formData
            });
            
            console.log('üì° Respuesta de upload:', uploadResponse.status);
            const uploadResult = await uploadResponse.json();
            console.log('üì¶ Resultado de upload:', uploadResult);
            
            if (uploadResponse.ok) {
                imagenUrl = uploadResult.path;
                console.log('‚úÖ Imagen subida exitosamente:', imagenUrl);
            } else {
                console.error('‚ùå Error subiendo imagen:', uploadResult);
                alert('Error subiendo imagen: ' + uploadResult.error);
                return;
            }
        }
        
        // Validaci√≥n: debe haber una imagen (archivo o URL)
        if (!imagenUrl && (!fileInput || !fileInput.files || fileInput.files.length === 0)) {
            console.warn('‚ö†Ô∏è No hay imagen seleccionada');
            alert('Debe seleccionar una imagen o ingresar una URL de imagen');
            return;
        }
        
        if (btn) btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Guardando promoci√≥n...';
        
        const formData = new FormData(document.getElementById('promocionForm'));
        const promocionId = document.getElementById('promocionId').value;
        
        const data = {
            titulo: formData.get('titulo'),
            imagen: imagenUrl, // Usar la URL subida o la URL manual
            activo: document.getElementById('promocionActivo').checked ? 1 : 0
        };
        
        console.log('üìã Datos a enviar:', data);
        
        const url = promocionId ? `http://localhost:5000/promociones/${promocionId}` : 'http://localhost:5000/promociones';
        const method = promocionId ? 'PUT' : 'POST';
        
        console.log('üöÄ Enviando petici√≥n:', { url, method });
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        console.log('üì° Respuesta del servidor:', response.status);
        const result = await response.json();
        console.log('üì¶ Resultado:', result);
        
        if (response.ok) {
            console.log('‚úÖ Promoci√≥n guardada exitosamente:', result);
            alert(promocionId ? 'Promoci√≥n actualizada exitosamente' : 'Promoci√≥n creada exitosamente');
            $('#promocionModal').modal('hide');
            
            // Recargar promociones despu√©s de un peque√±o delay
            setTimeout(() => {
                console.log('üîÑ Recargando lista de promociones...');
                cargarPromociones();
            }, 500);
        } else {
            console.error('‚ùå Error del servidor:', result);
            alert('Error: ' + result.error);
        }
        
    } catch (error) {
        console.error('üí• Error guardando promoci√≥n:', error);
        alert('Error al guardar la promoci√≥n: ' + error.message);
    } finally {
        if (btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
        console.log('üèÅ guardarPromocion finalizada');
    }
}

// Funci√≥n para editar promoci√≥n
async function editarPromocion(id) {
    try {
        const response = await fetch('http://localhost:5000/promociones/admin');
        const promociones = await response.json();
        const promocion = promociones.find(p => p.id === id);
        
        if (!promocion) {
            alert('Promoci√≥n no encontrada');
            return;
        }
        
        // Llenar el formulario
        document.getElementById('promocionId').value = promocion.id;
        document.getElementById('promocionTitulo').value = promocion.titulo || '';
        document.getElementById('promocionImagen').value = promocion.imagen;
        document.getElementById('promocionActivo').checked = promocion.activo;
        
        // Cambiar t√≠tulo del modal
        document.getElementById('promocionModalLabel').textContent = 'Editar Promoci√≥n';
        
        // Mostrar vista previa
        mostrarVistaPrevia(promocion.imagen);
        
        // Mostrar modal
        $('#promocionModal').modal('show');
        
    } catch (error) {
        console.error('Error cargando promoci√≥n:', error);
        alert('Error al cargar los datos de la promoci√≥n');
    }
}

// Funci√≥n para eliminar promoci√≥n
async function eliminarPromocion(id) {
    if (!confirm('¬øEst√°s seguro de que quieres eliminar esta promoci√≥n?')) {
        return;
    }
    
    try {
        const response = await fetch(`http://localhost:5000/promociones/${id}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('Promoci√≥n eliminada exitosamente');
            cargarPromociones();
        } else {
            alert('Error: ' + result.error);
        }
        
    } catch (error) {
        console.error('Error eliminando promoci√≥n:', error);
        alert('Error al eliminar la promoci√≥n');
    }
}

// Inicializar componente cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ [DOMContentLoaded] Inicializando componente promociones...');
    if (!window.promocionesComponenteInicializado) {
        inicializarPromocionesEventListeners();
        cargarPromociones();
        window.promocionesComponenteInicializado = true;
    }
});

// Tambi√©n llamar cuando se carga el componente din√°micamente
if (typeof window.inicializarPromociones === 'undefined') {
    window.inicializarPromociones = function() {
        console.log('üîÑ [inicializarPromociones] Inicializaci√≥n din√°mica...');
        
        // Evitar m√∫ltiples inicializaciones
        if (window.promocionesComponenteInicializado) {
            console.log('‚è≠Ô∏è [inicializarPromociones] Ya inicializado, solo recargando datos...');
            cargarPromociones();
            return;
        }
        
        // Exponer funciones globalmente
        window.guardarPromocion = guardarPromocion;
        window.cargarPromociones = cargarPromociones;
        window.editarPromocion = editarPromocion;
        window.eliminarPromocion = eliminarPromocion;
        window.inicializarPromocionesEventListeners = inicializarPromocionesEventListeners;
        
        console.log('‚úÖ [inicializarPromociones] Funciones expuestas globalmente');
        
        // Dar tiempo al DOM a renderizarse antes de inicializar
        setTimeout(() => {
            console.log('‚è∞ [inicializarPromociones] Ejecutando inicializaci√≥n despu√©s del timeout...');
            inicializarPromocionesEventListeners();
            cargarPromociones();
            window.promocionesComponenteInicializado = true;
        }, 100);
    };
    console.log('‚úÖ [inicializarPromociones] Funci√≥n window.inicializarPromociones definida');
}

// Exponer funciones inmediatamente tambi√©n
window.guardarPromocion = guardarPromocion;
window.cargarPromociones = cargarPromociones;
window.editarPromocion = editarPromocion;
window.eliminarPromocion = eliminarPromocion;
console.log('üåê [setup] Funciones de promociones disponibles globalmente');

// Forzar carga si ya estamos en un entorno cargado (solo una vez)
if ((document.readyState === 'complete' || document.readyState === 'interactive') && !window.promocionesComponenteInicializado) {
    console.log('üìÑ [setup] Documento ya listo, cargando promociones inmediatamente...');
    setTimeout(() => {
        const tbody = document.getElementById('promocionesTableBody');
        if (tbody && !window.promocionesComponenteInicializado) {
            console.log('üéØ [setup] Elemento encontrado, cargando promociones...');
            inicializarPromocionesEventListeners();
            cargarPromociones();
            window.promocionesComponenteInicializado = true;
        }
    }, 50);
}
        }
    }, 50);
}

// Test de conectividad
async function testConectividad() {
    try {
        console.log('üîå Probando conectividad con el servidor...');
        const response = await fetch('http://localhost:5000/promociones/admin');
        console.log('üì° Estado de respuesta:', response.status);
        console.log('üì° Headers:', response.headers);
        const data = await response.json();
        console.log('üì¶ Datos recibidos en test:', data);
        return true;
    } catch (error) {
        console.error('‚ùå Error de conectividad:', error);
        return false;
    }
}

// Funci√≥n de debug simple
window.debugPromociones = function() {
    console.log('üîç === DEBUG PROMOCIONES ===');
    console.log('Elementos DOM:');
    console.log('- promocionesTableBody:', !!document.getElementById('promocionesTableBody'));
    console.log('- promocionesTable:', !!document.getElementById('promocionesTable'));
    console.log('Estado del documento:', document.readyState);
    
    testConectividad().then(conectado => {
        console.log('Conectividad:', conectado ? '‚úÖ OK' : '‚ùå FALLO');
        if (conectado) {
            console.log('üîÑ Intentando cargar promociones...');
            cargarPromociones();
        }
    });
};

console.log('üåê Debug function disponible: window.debugPromociones()');
</script>
